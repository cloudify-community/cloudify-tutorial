tosca_definitions_version: cloudify_dsl_1_3

description: >
  This blueprint creates infrastructure on AWS using Terraform.
imports:
  - http://cloudify.co/spec/cloudify/5.0.5/types.yaml
  - plugin:cloudify-terraform-plugin
  - plugin:cloudify-utilities-plugin?version= >=1.22.1

inputs:
  terraform_version:
    type: string
    default: 0.13.1
    constraints:
      - valid_values:
        - 1.0.4
        - 1.0.3
        - 1.0.2
        - 1.0.1
        - 1.0.0
        - 0.15.5
        - 0.15.4
        - 0.15.3
        - 0.15.2
        - 0.15.1
        - 0.15.0
        - 0.14.11
        - 0.14.10
        - 0.14.9
        - 0.14.8
        - 0.14.7
        - 0.14.6
        - 0.14.5
        - 0.14.4
        - 0.14.3
        - 0.14.2
        - 0.14.1
        - 0.14.0
        - 0.13.7
        - 0.13.6
        - 0.13.5
        - 0.13.4
        - 0.13.3
        - 0.13.2
        - 0.13.1
        - 0.13.0


  environment_variables:
    type: dict
    default: {}


node_templates:
  terraform:
    type: cloudify.nodes.terraform
    properties:
      resource_config:
        installation_source: { concat: ['https://releases.hashicorp.com/terraform/', { get_input: terraform_version }, '/terraform_', { get_input: terraform_version }, '_linux_amd64.zip']}

  cloud_resources:
    type: cloudify.nodes.terraform.Module
    properties:
      resource_config:
        source: 
          location: 'https://github.com/cloudify-community/cloudify-tutorial.git'
        source_path: 'terraform/tf_11_eks_provision/template'
        variables:
          access_key: { get_secret: aws_access_key_id }
          secret_key: { get_secret: aws_secret_access_key }
          aws_region: eu-west-3
          cluster_name: eks-training
        environment_variables: { get_input: environment_variables }
    relationships:
      - target: terraform
        type: cloudify.terraform.relationships.run_on_host
  
